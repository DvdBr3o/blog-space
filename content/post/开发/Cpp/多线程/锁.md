---
title: é”
date: 2025-04-01T19:46:56+08:00
lastmod: 2025-04-02T12:11:10+08:00
tags:
  - å¤šçº¿ç¨‹
  - åŒæ­¥
  - cpp
categories: C++
publish: true
---

```cardlink
url: https://blog.csdn.net/iuices/article/details/123173966
title: "C++å¤šçº¿ç¨‹ï¼šé”ç®¡ç†(lock)_c++ lock-CSDNåšå®¢"
description: "æ–‡ç« æµè§ˆé˜…è¯»1.2wæ¬¡ï¼Œç‚¹èµ14æ¬¡ï¼Œæ”¶è—63æ¬¡ã€‚å¯¹äºå¤šçº¿ç¨‹ï¼Œæ— æ³•é¿å…è¦ä½¿ç”¨åˆ°é”å¯¹å…±äº«èµ„æºçš„ä¿æŠ¤ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥å­¦ä¹ ç°ä»£C++å¯¹äºé”çš„ç®¡ç†(lock)ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»å­¦ä¹ äº†ç°ä»£C++å¯¹åº”çš„mutexï¼Œç›´åˆ°C++17ï¼Œä¸€å…±æœ‰å…­ç§ç±»å‹ã€‚è€Œä»Šå¤©å­¦ä¹ çš„é”ç®¡ç†ï¼Œä¸mutexæ¯æ¯ç›¸å…³ï¼Œå®ƒä»¬éƒ½æ˜¯ä½¿ç”¨RAIIé£æ ¼æ¥è¿›è¡Œé”ç®¡ç†ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ç§ï¼šstd::lock_guard(C++11)std::unique_lock(C++11)std::share_lock(C++14)std::scoped_lock(C++17)é¦–å…ˆæ¥ç®€å•è§£é‡Šä¸€ä¸‹RAIIè¿™ä¸ªåç§°çš„æ„æ€ï¼šâã€ŒRAII_c++ lock"
host: blog.csdn.net
```

```mermaid
graph LR
LK(é”) ---> std::lock_guard
LK ---> std::unique_lock
LK ---> std::shared_lock
LK ---> std::scoped_lock
```

>[!info] çº¦å®š
>```cpp
>struct Foo {
>	std::mutex _data1_mtx;
>	std::mutex _data2_mtx;
>	int        _data1;
>	float      _data2;
>};
>```

## é”ç­–ç•¥

| é”ç­–ç•¥               | æ‰€æœ‰æƒ                        | è¡Œä¸º                     |
| ----------------- | -------------------------- | ---------------------- |
| é»˜è®¤                | æŒæœ‰ mutex æ‰€æœ‰æƒ               | æ„é€ é”æ—¶ç›´æ¥è°ƒç”¨ `.lock()`     |
| `std::defer_lock` | ä¸æŒæœ‰ mutex æ‰€æœ‰æƒ              | ä¸è°ƒç”¨ `.lock()`ï¼Œæ‰‹åŠ¨å»¶åè°ƒç”¨   |
| `std::try_lock`   | å°è¯•æŒæœ‰ mutex æ‰€æœ‰æƒï¼Œä¸é˜»å¡         | æ„é€ é”æ—¶ç›´æ¥è°ƒç”¨ `.try_lock()` |
| `std::adopt_lock` | å€Ÿç”¨ mutex æ‰€æœ‰æƒï¼Œå‡è®¾ mutex å·²è¢«å æœ‰ | ä¸è°ƒç”¨ `.lock()`          |

## lock_guard

æœ€ç®€å•çš„ lockï¼Œæœ€çº¯ç²¹çš„ raii é£å‘³

```cpp
void Foo::foo() {
	std::lock_guard lock { _data1_mtx };
	_data1 = 2;                  // read
	std::cout << _data1 << "\n"; // write
	// auto unlock from `~lock_guard()`
}
```

>[!note] å¤šé”æ­»é”
>
>è€ƒè™‘è¿™ç§æƒ…å†µ
>
>```cpp
>void Foo::foo1() {
>	std::lock_guard lock1 { _data1_mtx };
>	std::lock_guard lock2 { _data2_mtx }; // dead lock
>	_data1 = _data2 + 0.805f;
>}
>
>void Foo::foo2() {
>	std::lock_guard lock2 { _data2_mtx };
>	std::lock_guard lock1 { _data1_mtx }; // dead lock
>	_data2 = _data1 + 907;
>}
>
>void Foo::foo() {
>	auto thread1 = std::jthread { [this] { foo1(); } };
>	auto thread2 = std::jthread { [this] { foo2(); } };
>}
>```
>
>å› ä¸º `foo1()` ç¬¬ä¸€æ—¶é—´é”äº† `_data1_mtx` è€Œ `foo2()` ç¬¬ä¸€æ—¶é—´é”äº† `_data2_mtx`
>æ‰€ä»¥å½“ä¸¤è€…å‡ ä¹åŒæ—¶æ‰§è¡Œåˆ°è‡ªå·±çš„ç¬¬äºŒè¡Œæ—¶ï¼Œéƒ½å·²ç»å…ˆè¢«å¯¹æ–¹é”äº†ï¼Œé€ æˆäº†æ­»é”
>è§£å†³æ–¹æ³•åº”ä½¿ç”¨ [lock](%E9%94%81.md#lock) æˆ–è€… [scoped_lock](%E9%94%81.md#scopedlock)(C++17)

## unique_lock

[lock_guard](%E9%94%81.md#lockguard) å‡çº§ç‰ˆ

- [ ] TODO: å®Œæˆ [unique_lock](%E9%94%81.md#uniquelock) ğŸ“… 2025-04-06 

## lock

åŒæ—¶é”å¤šä¸ª lock

```cpp
void Foo::foo() {
	std::unique_lock lock1 { _data1_mtx, std::defer_lock };
	std::unique_lock lock2 { _data2_mtx, std::defer_lock };
	std::lock(lock1, lock2);
	_data1 = _data2 + 0.805f;
}
```

## shared_lock

ISO å®˜æ–¹è¯»å†™é”

>[!info] å¤šçº¿ç¨‹ã®è¯»å†™å®‰å…¨
>
>ä¸»æµçš„å®‰å…¨æ¨¡å‹ (inc. rust) è®¤ä¸º
>- åŒæ—¶ä¸€å†™æ— è¯»
>- åŒæ—¶æ— å†™å¤šè¯»
>
>æ˜¯å®‰å…¨çš„

ç”±å¤šçº¿ç¨‹ã®çš„è¯»å†™å®‰å…¨å¯çŸ¥

| æ–¹æ³•                                | ä¿æŠ¤æ“ä½œ   | mutex æ‰€æœ‰æƒ |
| --------------------------------- | ------ | --------- |
| `lock_shared()`/`unlock_shared()` | **å¤šè¯»** | è¢«å¤šä¸ªè¯»çº¿ç¨‹é”æŒæœ‰ |
| `lock()`/`unlock()`               | **ä¸€å†™** | è¢«ä¸€ä¸ªå†™çº¿ç¨‹é”æŒæœ‰ |

## scoped_lock

C++17 å¸¦æ¥çš„å¤šé” quality-of-life å·¥å…·

å¯¹æ¯”ä¸€ä¸‹ `std::lock`

```cpp
// std::lock
void Foo::foo_lock() {
	std::unique_lock lock1 { _data1_mtx, std::defer_lock };
	std::unique_lock lock2 { _data2_mtx, std::defer_lock };
	std::lock(lock1, lock2);
	_data1 = _data2 + 0.805f;
}
```

vs.

```cpp
// std::scoped_lock
void Foo::foo_scoped_lock() {
	std::scoped_lock lock { _data1_mtx, _data2_mtx };
	_data1 = _data2 + 0.805f;
}
```

## æœ€ä½³å®è·µ

### mm åŸåˆ™

å› ä¸ºæœ‰æ—¶å€™å¯¹è±¡çš„è¯»æ“ä½œåº”è¯¥å¯¹å¤–åªè¦æ±‚ `const&` 

ä½†æ˜¯é” mutex æ“ä½œéœ€è¦ mutex é `const`

æ‰€ä»¥å»ºè®®å¯¹æ‰€æœ‰éœ€è¦å¯¹å¤–æä¾›è¯»æ“ä½œçš„ mutex åŠ ä¸Š `mutable` æ ‡ç­¾

```cpp
class Foo {
public:
	int get_data() const {
		std::scoped_lock lock { _mtx };
		return _data;
	}

private:
	// ...
	mutable std::mutex _mtx;
	int _data;
};
```

